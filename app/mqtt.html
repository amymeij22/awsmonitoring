<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT WebSocket Client</title>
    <script src="https://cdn.jsdelivr.net/npm/mqtt@4.2.8/dist/mqtt.min.js"></script>
</head>
<body>
    <h1>MQTT WebSocket Client</h1>
    <div id="messages"></div>

    <script>
        // URL broker HiveMQ Cloud
        const brokerUrl = "wss://5e3ab8b3f55c42c9be04a01b2e47662a.s1.eu.hivemq.cloud:8884/mqtt";
        
        // Credentials
        const username = "kabagas";
        const password = "@KabagasKeren082333";
        
        // Membuat koneksi MQTT dengan opsi WebSocket
        const client = mqtt.connect(brokerUrl, {
            username: username,
            password: password,
            clean: true,
            reconnectPeriod: 1000,
        });

        // Event ketika koneksi berhasil
        client.on('connect', function () {
            console.log('Connected to HiveMQ Cloud');
            // Subscribe ke topik 'awsData'
            client.subscribe('awsData', function (err) {
                if (err) {
                    console.error('Failed to subscribe:', err);
                } else {
                    console.log('Subscribed to topic "awsData"');
                }
            });
        });

        // Event ketika pesan diterima
        client.on('message', function (topic, message) {
            console.log('Received message:', message.toString());
            
            // Parse pesan JSON
            const data = JSON.parse(message.toString());

            // Menyimpan data ke Supabase
            saveDataToSupabase(data);

            // Menampilkan pesan ke dalam div dengan ID 'messages'
            document.getElementById('messages').innerHTML += `<p>Topic: ${topic} - Message: ${message.toString()}</p>`;
        });

        // Fungsi untuk menyimpan data ke Supabase
        async function saveDataToSupabase(data) {
            // Konfigurasi Supabase
            const SUPABASE_URL = 'https://rnohmgefbajzshtexqqb.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJub2htZ2VmYmFqenNodGV4cXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY0MzEwNjIsImV4cCI6MjA1MjAwNzA2Mn0.qruVK-1iiUUjcT2b7iDg1ln2QFjU3nANEVgdohioPwk';
            
            const response = await fetch(`${SUPABASE_URL}/rest/v1/weather_data`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'apikey': SUPABASE_KEY
                },
                body: JSON.stringify({
                    temp: data.Temp,
                    hum: data.Rh,
                    wind_direction: data['wind.Direction'],
                    wind_speed: data['wind.Speed'],
                    pressure: data.pressure,
                    radiation: data.radiation,
                    precipitation: data.precipitation
                })
            });

            if (response.ok) {
                console.log('Data saved to Supabase');
            } else {
                console.error('Failed to save data to Supabase:', response.status, response.statusText);
            }
        }

        // Event ketika koneksi gagal
        client.on('error', function (err) {
            console.error('Connection error:', err);
        });

        // Event ketika koneksi terputus
        client.on('close', function () {
            console.log('Connection closed');
        });
    </script>
</body>
</html>
